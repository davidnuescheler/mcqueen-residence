{"version":3,"sources":["html.pre.js"],"names":["jquery","require","fetchGoogle","fetchFSTab","pre","context","document","content","$","defaultView","$sections","body","children","first","has","addClass","find","wrapAll","filter","not","length","module","exports","before","fetch","action","fstab","logger","request","secrets","idx","params","path","lastIndexOf","resourcePath","decodeURIComponent","substring","info","mountpoints","forEach","m","root","endsWith","url","id","startsWith","type","split","pop","mp","warn","relPath","oldRaw","REPO_RAW_ROOT","oldTimeout","HTTP_TIMEOUT","GOOGLE_DOCS_ROOT"],"mappings":"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","file":"html.pre.js","sourceRoot":"../pages/master/src","sourcesContent":["/*\n * Copyright 2019 Adobe. All rights reserved.\n * This file is licensed to you under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License. You may obtain a copy\n * of the License at http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software distributed under\n * the License is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR REPRESENTATIONS\n * OF ANY KIND, either express or implied. See the License for the specific language\n * governing permissions and limitations under the License.\n */\nconst jquery = require('jquery');\nconst fetchGoogle = require('./fetch-google.js');\nconst fetchFSTab = require('./fetch-fstab.js');\n\n/**\n * The 'pre' function that is executed before the HTML is rendered\n * @param context The current context of processing pipeline\n * @param context.content The content\n */\nfunction pre(context) {\n  const { document } = context.content;\n  const $ = jquery(document.defaultView);\n\n  const $sections = $(document.body).children('div');\n\n  // first section has a starting image: add title class and wrap all subsequent items inside a div\n  $sections\n    .first()\n    .has('p:first-child>img')\n    .addClass('title')\n    .find(':nth-child(1n+2)')\n    .wrapAll('<div class=\"header\"></div>');\n\n  // sections consisting of only one image\n  $sections\n    .filter('[data-hlx-types~=\"has-only-image\"]')\n    .not('.title')\n    .addClass('image');\n\n  // sections without image and title class gets a default class\n  $sections\n    .not('.image')\n    .not('.title')\n    .addClass('default');\n\n  // if there are no sections wrap everything in a default div\n  if ($sections.length === 0) {\n    $(document.body).children().wrapAll('<div class=\"default\"></div>');\n  }\n}\n\nmodule.exports.pre = pre;\n\nmodule.exports.before = {\n  fetch: async (context, action) => {\n    // could be separate pipeline step or done completely in the dispatcher\n    const fstab = await fetchFSTab(context, action);\n    if (!fstab) {\n      return;\n    }\n    const { logger, request, secrets } = action;\n    const idx = request.params.path.lastIndexOf('.');\n    const resourcePath = decodeURIComponent(request.params.path.substring(0, idx));\n\n    logger.info(`resourcePath=${resourcePath}`);\n\n    // sanitize the mountpoints\n    fstab.mountpoints.forEach((m) => {\n      if (!m.root.endsWith('/')) {\n        m.root += '/';\n      }\n      if (m.url && !m.id) {\n        if (m.url.startsWith('https://drive.google.com/')) {\n          m.type = 'google';\n          m.id = m.url.split('/').pop();\n        }\n      }\n    });\n    const mp = fstab.mountpoints.find((m) => resourcePath.startsWith(m.root));\n    if (!mp) {\n      logger.info(`no mount point for ${resourcePath}`);\n      return;\n    }\n    if (mp.type !== 'google') {\n      logger.info(`mount point type '${mp.type}' not supported.`);\n      return;\n    }\n    if (!mp.id) {\n      logger.warn('google docs mountpoint needs id');\n      return;\n    }\n\n    const relPath = resourcePath.substring(mp.root.length - 1);\n    logger.info(`relPath=${relPath}`);\n    const oldRaw = secrets.REPO_RAW_ROOT;\n    const oldTimeout = secrets.HTTP_TIMEOUT;\n    secrets.REPO_RAW_ROOT = secrets.GOOGLE_DOCS_ROOT || 'https://adobeioruntime.net/api/v1/web/helix/helix-services/gdocs2md@latest';\n    // ump the timeout a bit, since the google docs script might take a while to render\n    secrets.HTTP_TIMEOUT = 10000;\n    try {\n      await fetchGoogle(context, action, relPath, mp.id);\n    } finally {\n      secrets.REPO_RAW_ROOT = oldRaw;\n      secrets.HTTP_TIMEOUT = oldTimeout;\n    }\n  },\n};\n"]}